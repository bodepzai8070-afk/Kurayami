<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kurayami - Văn Sử</title>
    <link rel="manifest" href="data:application/manifest+json,{\"name\":\"Kurayami\",\"short_name\":\"KVS\",\"start_url\":\".\",\"display\":\"standalone\",\"background_color\":\"#0f0c29\",\"theme_color\":\"#6e8efb\",\"icons\":[{\"src\":\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%236e8efb'/%3E%3Ctext x='50' y='60' font-family='Arial' font-size='40' fill='white' text-anchor='middle'%3EK%3C/text%3E%3C/svg%3E\",\"sizes\":\"192x192\",\"type\":\"image/svg+xml\"}]}">
    <meta name="theme-color" content="#6e8efb">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src https://api.github.com https://api.ipify.org https://ipinfo.io">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
        body{background:#0f0c29;color:#e0e0e0;line-height:1.7;padding:20px;}
        .container{max-width:1000px;margin:auto;background:#1a1a2e;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.5);overflow:hidden;}
        header{background:linear-gradient(135deg,#6e8efb,#a777e3);color:#fff;padding:25px;text-align:center;}
        header h1{font-size:2rem;margin-bottom:8px;}
        header p{font-size:1rem;opacity:.9;}
        .section{padding:30px;border-bottom:1px solid #333;}
        .section:last-child{border-bottom:none;}
        h2{color:#6e8efb;margin-bottom:15px;font-size:1.5rem;border-left:4px solid #6e8efb;padding-left:12px;}
        label{display:block;margin-bottom:8px;font-weight:600;color:#ccc;}
        input[type=text],textarea,select{width:100%;padding:12px;margin-bottom:15px;border:1px solid #444;border-radius:8px;font-size:1rem;background:#222;color:#fff;transition:border .3s;}
        input:focus,textarea:focus,select:focus{outline:none;border-color:#6e8efb;box-shadow:0 0 0 3px rgba(110,142,251,.2);}
        textarea{min-height:300px;resize:vertical;line-height:1.8;}
        .actions{text-align:right;margin-top:15px;}
        button{background:#6e8efb;color:#fff;border:none;padding:12px 28px;border-radius:8px;font-size:1rem;cursor:pointer;transition:.3s;}
        button:hover{background:#5a78e0;}
        .msg{background:#331100;border:1px solid #8b5a00;color:#ffcc80;padding:15px;border-radius:8px;margin:15px 0;font-weight:600;font-style:italic;display:none;position:relative;}
        .msg::before{content:"Kurayami:";font-weight:700;color:#ffb84d;}
        .warning-box{background:#8b0000;border:2px solid #ff4444;color:#ffcc80;padding:15px;border-radius:8px;margin:15px 0;font-weight:700;text-align:center;display:none;animation:blink 1s infinite;}
        @keyframes blink{0%,100%{opacity:1;}50%{opacity:0.5;}}
        .locked{pointer-events:none;opacity:0.3;position:relative;}
        .locked::after{content:"KHÔNG ĐƯỢC VIẾT VĂN-SỬ NGOÀI PHÁP LUẬT";position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#8b0000;color:#fff;padding:25px 40px;border-radius:12px;font-weight:700;z-index:9999;box-shadow:0 8px 25px rgba(0,0,0,.8);font-size:1.3rem;text-align:center;}
        .locked::before{content:"Liên hệ FB: https://www.facebook.com/share/1DL1y8SSbn/ để gỡ ban. Lý do: [REASON]. Đã ghi nhận IP + Thiết bị.";display:block;margin-top:10px;color:#ffcc80;font-size:1rem;}
        .warning{background:#331100;border:1px solid #663300;color:#ffcc66;padding:15px;border-radius:8px;margin:15px 0;font-weight:600;display:block;}
        .satire-notice{background:#1a3a1a;border:1px solid #4a9a4a;color:#a0ffa0;padding:12px;border-radius:8px;margin:10px 0;font-weight:600;font-style:italic;}
        .satire-notice::before{content:"Kurayami phát hành:";font-weight:700;color:#6eff6e;}
        .ranking{background:#222;padding:15px;border-radius:8px;margin-top:20px;}
        .ranking h3{color:#6e8efb;margin-bottom:10px;}
        .rank-item{padding:8px 0;border-bottom:1px solid #444;}
        .rank-item:last-child{border:none;}
        .rank-name{font-weight:600;color:#6e8efb;}
        .rank-total{font-weight:700;color:#a777e3;}
        .sync-status{font-size:0.8rem;color:#6eff6e;margin-top:5px;}
        footer{text-align:center;padding:20px;font-size:.9rem;color:#888;background:#111;}
        .devtools-warning{background:#ff4444;color:#fff;padding:10px;border-radius:8px;margin:10px 0;text-align:center;font-weight:700;display:none;}
    </style>
</head>
<body>
<div class="container" id="main">
    <header>
        <h1>Kurayami - Văn Sử</h1>
        <p>Điểm thật – Châm biếm VNCH +0.5 điểm</p>
    </header>

    <div class="section">
        <h2>Viết Bài</h2>
        <label for="username">Tên</label>
        <input type="text" id="username" placeholder="Tên của bạn...">

        <label for="type">Thể loại</label>
        <select id="type">
            <option value="lich">Lịch sử</option>
            <option value="van">Văn học</option>
        </select>

        <label for="title">Tiêu đề</label>
        <input type="text" id="title" placeholder="Tiêu đề...">

        <label for="content">Nội dung</label>
        <textarea id="content" placeholder="Viết ở đây..."></textarea>

        <div id="saveSuccess" class="save-success">Đã lưu! +<span id="earnedPoints"></span> điểm</div>
        <div id="devtoolsWarning" class="devtools-warning">PHÁT HIỆN DEVTOOLS → TỰ ĐỘNG BAN!</div>

        <div class="actions">
            <button id="saveBtn">Lưu Bài</button>
        </div>
    </div>

    <div class="section">
        <h2>Bảng Xếp Hạng</h2>
        <div class="ranking" id="ranking">
            <h3>Top 5</h3>
            <div id="rankList">Đang tải...</div>
            <div id="syncStatus" class="sync-status"></div>
        </div>
    </div>

    <div class="section">
        <h2>Quy Tắc</h2>
        <div class="warning">
            • Xúc phạm Bác Hồ, ĐCS → <strong>BAN VĨNH VIỄN THIẾT BỊ + IP + FINGERPRINT</strong><br>
            • Viết VNCH (không châm biếm) → <strong>BAN IP 30 NGÀY</strong><br>
            • Mở F12, dùng VPN → <strong>CẢNH BÁO + GIẢM ĐIỂM</strong><br>
            • <strong>Châm biếm hợp pháp:</strong> chó VNCH, đu càng, hèn như chó<br>
            • <strong>Liên hệ gỡ ban:</strong> <span onclick="window.open('https://www.facebook.com/share/1DL1y8SSbn/','_blank')" style="color:#6e8efb;cursor:pointer;">FB này</span>
        </div>
    </div>

    <footer>© 2025 Kurayami – Không thể bypass</footer>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    // === CẤU HÌNH ===
    const GIST_ID = 'DÁN_GIST_ID_THẬT_VÀO_ĐÂY';
    const GIST_TOKEN = 'DÁN_TOKEN_THẬT_VÀO_ĐÂY';
    const GIST_URL = `https://api.github.com/gists/${GIST_ID}`;
    const FB_LINK = 'https://www.facebook.com/share/1DL1y8SSbn/';

    const titleEl = document.getElementById('title');
    const contentEl = document.getElementById('content');
    const typeEl = document.getElementById('type');
    const saveBtn = document.getElementById('saveBtn');
    const saveSuccess = document.getElementById('saveSuccess');
    const earnedPoints = document.getElementById('earnedPoints');
    const main = document.getElementById('main');
    const rankList = document.getElementById('rankList');
    const syncStatus = document.getElementById('syncStatus');
    const devtoolsWarning = document.getElementById('devtoolsWarning');

    let serverData = { scores: {}, bans: {}, fingerprints: {} };
    let fingerprint = null;
    let currentIP = null;

    // === FINGERPRINT ===
    async function generateFingerprint() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('Kurayami Fingerprint', 2, 2);
        const canvasData = canvas.toDataURL();

        const gl = canvas.getContext('webgl');
        const debugInfo = gl?.getExtension('WEBGL_debug_renderer_info');
        const renderer = debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : gl.getParameter(gl.RENDERER);

        const hints = {
            platform: navigator.platform,
            userAgent: navigator.userAgent,
            language: navigator.language,
            screen: `${screen.width}x${screen.height}`,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
        };

        return btoa(JSON.stringify({ canvasData, renderer, hints })).slice(0, 64);
    }

    // === LẤY IP + KIỂM TRA VPN ===
    async function getIPInfo() {
        try {
            const res = await fetch('https://ipinfo.io/json');
            const data = await res.json();
            currentIP = data.ip;
            return { ip: data.ip, org: data.org, isVPN: data.org.includes('Amazon') || data.org.includes('Google') || data.org.includes('Cloudflare') };
        } catch {
            return { ip: null, isVPN: false };
        }
    }

    // === TẢI DỮ LIỆU ===
    async function loadData() {
        try {
            const res = await fetch(GIST_URL, { headers: { 'Authorization': `token ${GIST_TOKEN}` } });
            if (!res.ok) throw new Error();
            const data = await res.json();
            const file = data.files['kurayami_secure.json'];
            serverData = file && file.content ? JSON.parse(file.content) : { scores: {}, bans: {}, fingerprints: {} };
            updateRanking();
        } catch { syncStatus.textContent = 'Lỗi server'; }
    }

    // === LƯU DỮ LIỆU ===
    async function saveData() {
        try {
            await fetch(GIST_URL, {
                method: 'PATCH',
                headers: { 'Authorization': `token ${GIST_TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: { 'kurayami_secure.json': { content: JSON.stringify(serverData, null, 2) } } })
            });
            syncStatus.textContent = 'Đã lưu!';
            setTimeout(() => syncStatus.textContent = '', 2000);
        } catch {}
    }

    // === CẬP NHẬT XẾP HẠNG ===
    function updateRanking() {
        const top5 = Object.entries(serverData.scores).sort((a,b) => b[1] - a[1]).slice(0,5);
        rankList.innerHTML = top5.map(([n,s],i) => `<div class="rank-item"><span class="rank-name">#${i+1} ${n}</span> - <span class="rank-total">${s.toFixed(1)}</span></div>`).join('') || 'Chưa có';
    }

    // === BAN MẠNH TAY ===
    async function applyGlobalBan(reason, permanent = true) {
        const ipInfo = await getIPInfo();
        if (ipInfo.ip) serverData.bans[ipInfo.ip] = { time: Date.now(), reason, permanent };
        if (fingerprint) serverData.fingerprints[fingerprint] = { time: Date.now(), reason, permanent };
        await saveData();

        localStorage.setItem('k_perma_ban', 'true');
        localStorage.setItem('k_ban_reason', reason);
        main.classList.add('locked');
        document.querySelector('.locked::before').textContent = `Liên hệ FB: ${FB_LINK} để gỡ ban. Lý do: ${reason}. Đã ghi nhận IP + Thiết bị.`;
        alert(`BAN TOÀN CẦU: ${reason}\nLiên hệ: ${FB_LINK}`);
    }

    // === CHECK BAN ===
    async function checkBan() {
        const ipInfo = await getIPInfo();
        fingerprint = await generateFingerprint();

        if (serverData.fingerprints[fingerprint] || (ipInfo.ip && serverData.bans[ipInfo.ip])) {
            const ban = serverData.fingerprints[fingerprint] || serverData.bans[ipInfo.ip];
            main.classList.add('locked');
            document.querySelector('.locked::before').textContent = `Liên hệ FB: ${FB_LINK} để gỡ ban. Lý do: ${ban.reason}.`;
            return true;
        }
        return false;
    }

    // === CHỐNG XÚC PHẠM ===
    const FORBIDDEN = ['ho chi minh','bac ho','dang cong san','phan boi','chong dang','gian doc'];
    const VNCH_KEYS = ['vnch','viet nam cong hoa'];
    const SATIRE_KEYS = ['cho vnch','du cang','hen nhu cho'];

    function normalize(t) { return t.toLowerCase().replace(/[àáảãạ]/g,'a').replace(/đ/g,'d').replace(/[^a-z0-9\s]/g,' ').trim(); }

    function checkInsult() {
        const txt = normalize(titleEl.value + ' ' + contentEl.value);
        if (FORBIDDEN.some(w => txt.includes(w))) {
            applyGlobalBan('XÚC PHẠM HUYỀN THOẠI');
            return true;
        }
        return false;
    }

    function checkVNCH() {
        const txt = normalize(titleEl.value + ' ' + contentEl.value);
        const hasVNCH = VNCH_KEYS.some(w => txt.includes(w));
        const hasSatire = SATIRE_KEYS.some(w => txt.includes(w));
        if (hasVNCH && !hasSatire) {
            applyGlobalBan('VIẾT VNCH KHÔNG CHÂM BIẾM', false);
            return true;
        }
        return false;
    }

    // === CHỐNG F12 ===
    const devtools = { open: false };
    const threshold = 160;
    setInterval(() => {
        if (window.outerHeight - window.innerHeight > threshold || window.outerWidth - window.innerWidth > threshold) {
            if (!devtools.open) {
                devtools.open = true;
                devtoolsWarning.style.display = 'block';
                applyGlobalBan('MỞ DEVTOOLS');
            }
        } else devtools.open = false;
    }, 500);

    // === QUÉT KHI GÕ ===
    let typing = false;
    [titleEl, contentEl].forEach(el => {
        el.addEventListener('input', () => {
            if (!typing) {
                typing = true;
                setTimeout(() => {
                    checkInsult() || checkVNCH();
                    typing = false;
                }, 1000);
            }
        });
    });

    // === LƯU BÀI ===
    saveBtn.onclick = async () => {
        if (await checkBan()) return;
        const username = document.getElementById('username').value.trim();
        if (!username || !titleEl.value || !contentEl.value) return alert('Nhập đầy đủ!');

        if (checkInsult() || checkVNCH()) return;

        const score = typeEl.value === 'lich' ? 1 : (contentEl.value.split(/\s+/).length * 0.1);
        serverData.scores[username] = (serverData.scores[username] || 0) + score;
        localStorage.setItem('k_username', username);

        earnedPoints.textContent = score.toFixed(1);
        saveSuccess.style.display = 'block';
        setTimeout(() => saveSuccess.style.display = 'none', 3000);

        await saveData();
        updateRanking();
        titleEl.value = contentEl.value = '';
    };

    // === KHỞI TẠO ===
    const savedName = localStorage.getItem('k_username');
    if (savedName) document.getElementById('username').value = savedName;

    await loadData();
    await checkBan();
    setInterval(loadData, 10000);
});
</script>
</body>
</html>
