<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Viết Văn & Viết Sử - Kurayami</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #fafafa;
      margin: 0;
      padding: 0;
    }
    header {
      background: #222;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 1.5em;
    }
    main {
      max-width: 800px;
      margin: 30px auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
    }
    button {
      background: #0078ff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      margin-right: 10px;
      font-size: 1em;
    }
    button:hover {
      background: #005fcc;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    .post {
      background: #f7f7f7;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    .post h3 {
      margin: 0 0 10px;
    }
    .btn-group {
      margin-top: 10px;
    }
    #banNotice {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 1.6em;
      text-align: center;
      z-index: 9999;
      display: none;
      padding: 20px;
    }
    #banNotice.show {
      display: flex;
    }
    #countdown {
      font-size: 2.5em;
      margin: 20px 0;
      color: #ff3333;
      font-weight: bold;
    }
    #deviceId {
      font-size: 0.8em;
      margin-top: 15px;
      color: #ccc;
    }
    #reloadNotice {
      background: #ff3333;
      color: white;
      padding: 12px;
      text-align: center;
      font-weight: bold;
      margin-bottom: 20px;
      border-radius: 8px;
      font-size: 1.1em;
    }
    .warn-vnch {
      background: #fff3cd;
      color: #856404;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>Viết Văn & Viết Sử - Kurayami</header>
  
  <div id="reloadNotice">Web Kurayami – Tôi không nằm ngoài pháp luật. Ai quét mạnh tay! Cấm vĩnh viễn nếu xúc phạm.</div>

  <main>
    <div id="status" class="warn-vnch" style="display:none;"></div>

    <h2>Tạo bài viết mới</h2>
    <input id="title" type="text" placeholder="Nhập tiêu đề bài viết..." />
    <textarea id="content" rows="8" placeholder="Nhập nội dung bài viết..."></textarea>
    <button id="saveBtn" onclick="savePost()">Lưu bài</button>
    <button onclick="clearAll()">Xóa tất cả</button>

    <hr>

    <h2>Danh sách bài viết</h2>
    <div id="posts"></div>
  </main>

  <!-- Ban overlay -->
  <div id="banNotice">
    <p id="banTitle">BẠN ĐÃ BỊ CẤM!</p>
    <p id="banReason"></p>
    <div id="countdown"></div>
    <p id="deviceId"></p>
    <p style="font-size:0.9em; margin-top:20px;">Không thể bypass. Không fake VPN. Không xóa localStorage. Theo địa chỉ máy.</p>
  </div>

  <script>
    const postsDiv = document.getElementById('posts');
    const banNotice = document.getElementById('banNotice');
    const banTitle = document.getElementById('banTitle');
    const banReasonEl = document.getElementById('banReason');
    const countdownEl = document.getElementById('countdown');
    const deviceIdEl = document.getElementById('deviceId');
    const saveBtn = document.getElementById('saveBtn');
    const statusDiv = document.getElementById('status');

    // === TẠO ĐỊA CHỈ MÁY (Device Fingerprint) ===
    let deviceId = localStorage.getItem('kurayami_device_id');
    if (!deviceId) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillText('Kurayami Device ID', 2, 2);
      const data = canvas.toDataURL();
      deviceId = btoa(data + navigator.userAgent + screen.width + screen.height).substring(0, 32);
      localStorage.setItem('kurayami_device_id', deviceId);
    }
    deviceIdEl.textContent = `Máy: ${deviceId}`;

    // === DANH SÁCH TỪ KHÓA ===
    const bannedKeywords = {
      vnch: ['vnch', 'việt nam cộng hòa', 'ngụy quyền', 'ngụy quân'],
      dcsvn: ['đcs vn', 'đảng cộng sản việt nam', 'đảng csvn'],
      ho: ['bác hồ', 'hồ chí minh', 'bác h'],
      giap: ['bác giáp', 'võ nguyên giáp'],
      liet_si: /liệt\s*sĩ|anh\s*hùng.*(chửi|xúc phạm|đồ|kẻ)/i
    };

    const offensiveWords = {
      vnch: ['ngụy', 'phản động', 'bán nước', 'tay sai'],
      ho: ['kẻ', 'đồ', 'giả', 'dối', 'phản', 'tội đồ'],
      giap: ['phản', 'bội', 'tội đồ', 'kẻ']
    };

    // === LƯU TRỮ CẤM THEO MÁY ===
    const banKey = `kurayami_ban_${deviceId}`;
    let banData = JSON.parse(localStorage.getItem(banKey) || 'null');

    // === KIỂM TRA CẤM KHI LOAD ===
    function checkBan() {
      if (!banData) return;
      const now = Date.now();
      if (banData.permanent) {
        showPermanentBan();
      } else if (banData.until > now) {
        startCountdown(banData.until, banData.reason);
      } else {
        localStorage.removeItem(banKey);
        banData = null;
      }
    }

    function showPermanentBan() {
      banTitle.textContent = 'CẤM VĨNH VIỄN';
      banReasonEl.textContent = 'Xúc phạm ĐCS VN, Bác Hồ, Bác Giáp hoặc anh hùng liệt sĩ.';
      banNotice.classList.add('show');
      disableAllInputs();
    }

    function startCountdown(until, reason) {
      banTitle.textContent = 'CẤM 24 GIỜ';
      banReasonEl.textContent = reason;
      banNotice.classList.add('show');
      disableAllInputs();

      const interval = setInterval(() => {
        const remaining = Math.max(0, Math.floor((until - Date.now()) / 1000));
        if (remaining === 0) {
          clearInterval(interval);
          banNotice.classList.remove('show');
          localStorage.removeItem(banKey);
          banData = null;
          location.reload();
          return;
        }
        const h = String(Math.floor(remaining / 3600)).padStart(2, '0');
        const m = String(Math.floor((remaining % 3600) / 60)).padStart(2, '0');
        const s = String(remaining % 60).padStart(2, '0');
        countdownEl.textContent = `${h}:${m}:${s}`;
      }, 1000);
    }

    function disableAllInputs() {
      saveBtn.disabled = true;
      document.querySelectorAll('button, input, textarea').forEach(el => el.disabled = true);
    }

    // === PHÂN TÍCH NỘI DUNG ===
    function analyzePost(title, content) {
      const text = `${title} ${content}`.toLowerCase();
      let isVNCHMention = false;
      let isOffensive = false;
      const errors = [];

      // 1. Chỉ nhắc VNCH (không xúc phạm)
      for (const kw of bannedKeywords.vnch) {
        if (text.includes(kw)) {
          isVNCHMention = true;
          // Kiểm tra có xúc phạm không
          for (const bad of offensiveWords.vnch) {
            if (text.includes(bad)) {
              isOffensive = true;
              errors.push(`Xúc phạm VNCH với từ: "${bad}"`);
            }
          }
        }
      }

      // 2. Xúc phạm các đối tượng khác → CẤM VĨNH VIỄN
      if (bannedKeywords.dcsvn.some(kw => text.includes(kw.toLowerCase()))) {
        isOffensive = true;
        errors.push('Xúc phạm Đảng Cộng sản Việt Nam');
      }
      if (bannedKeywords.ho.some(kw => text.includes(kw.toLowerCase()))) {
        for (const bad of offensiveWords.ho) {
          if (text.includes(bad)) {
            isOffensive = true;
            errors.push(`Xúc phạm Bác Hồ với từ: "${bad}"`);
          }
        }
      }
      if (bannedKeywords.giap.some(kw => text.includes(kw.toLowerCase()))) {
        for (const bad of offensiveWords.giap) {
          if (text.includes(bad)) {
            isOffensive = true;
            errors.push(`Xúc phạm Đại tướng Võ Nguyên Giáp với từ: "${bad}"`);
          }
        }
      }
      if (bannedKeywords.liet_si.test(text)) {
        isOffensive = true;
        errors.push('Xúc phạm các anh hùng liệt sĩ');
      }

      return { isVNCHMention, isOffensive, errors };
    }

    // === LƯU BÀI VIẾT ===
    function savePost() {
      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      if (!title || !content) {
        alert('Vui lòng nhập đầy đủ tiêu đề và nội dung!');
        return;
      }

      const analysis = analyzePost(title, content);

      if (analysis.isOffensive) {
        // CẤM VĨNH VIỄN
        const reason = `VI PHẠM NGHIÊM TRỌNG: ${analysis.errors.join('; ')}`;
        localStorage.setItem(banKey, JSON.stringify({ permanent: true, reason }));
        showPermanentBan();
        return;
      }

      if (analysis.isVNCHMention) {
        // CHỈ NHẮC VNCH → CẤM 24H
        const reason = 'Chỉ được nhắc VNCH 1 lần. Tái phạm: cấm vĩnh viễn.';
        const until = Date.now() + 24 * 60 * 60 * 1000;
        localStorage.setItem(banKey, JSON.stringify({ until, reason, permanent: false }));
        startCountdown(until, reason);
        statusDiv.textContent = 'Cảnh báo: Đã nhắc VNCH → Cấm 24h. Không được nhắc lại!';
        statusDiv.style.display = 'block';
        return;
      }

      // HỢP LỆ → LƯU
      const post = { id: Date.now(), title, content };
      const posts = JSON.parse(localStorage.getItem('kurayami_posts') || '[]');
      posts.push(post);
      localStorage.setItem('kurayami_posts', JSON.stringify(posts));
      document.getElementById('title').value = '';
      document.getElementById('content').value = '';
      loadPosts();
      alert('Bài viết đã lưu thành công!');
    }

    // === HIỂN THỊ DANH SÁCH ===
    function loadPosts() {
      postsDiv.innerHTML = '';
      const posts = JSON.parse(localStorage.getItem('kurayami_posts') || '[]');
      posts.reverse().forEach(post => {
        const div = document.createElement('div');
        div.className = 'post';
        div.innerHTML = `
          <h3>${post.title}</h3>
          <div class="btn-group">
            <button onclick="viewPost(${post.id})">Xem</button>
            <button onclick="deletePost(${post.id})">Xóa</button>
          </div>
        `;
        postsDiv.appendChild(div);
      });
    }

    function viewPost(id) {
      const posts = JSON.parse(localStorage.getItem('kurayami_posts') || '[]');
      const post = posts.find(p => p.id === id);
      if (post) alert(`📜 ${post.title}\n\n${post.content}`);
    }

    function deletePost(id) {
      if (confirm('Xóa bài này?')) {
        let posts = JSON.parse(localStorage.getItem('kurayami_posts') || '[]');
        posts = posts.filter(p => p.id !== id);
        localStorage.setItem('kurayami_posts', JSON.stringify(posts));
        loadPosts();
      }
    }

    function clearAll() {
      if (confirm('Xóa tất cả bài viết?')) {
        localStorage.removeItem('kurayami_posts');
        loadPosts();
      }
    }

    // === KHỞI ĐỘNG ===
    checkBan();
    loadPosts();

    // Thông báo reload
    window.addEventListener('load', () => {
      document.getElementById('reloadNotice').style.display = 'block';
    });
  </script>
</body>
</html>
