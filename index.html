<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kurayami – Viết Cảm Xúc</title>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --kurayami-purple: #6a1b9a;
      --kurayami-pink: #ec407a;
      --kurayami-light: #f3e5f5;
      --kurayami-dark: #4a148c;
      --shadow: 0 4px 10px rgba(106, 27, 154, 0.2);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #ede7f6, #f3e5f5);
      color: #333;
      font-size: 16px;
      line-height: 1.5;
      overflow-x: hidden;
    }
    header {
      background: linear-gradient(to right, var(--kurayami-purple), var(--kurayami-pink));
      color: white;
      padding: 15px;
      text-align: center;
      font-family: 'Dancing Script', cursive;
      font-size: 1.8em;
      box-shadow: var(--shadow);
    }
    main {
      max-width: 100%;
      padding: 15px;
    }
    h2 {
      color: var(--kurayami-purple);
      font-family: 'Dancing Script', cursive;
      font-size: 1.5em;
      text-align: center;
      margin: 10px 0;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 2px solid #e1bee7;
      border-radius: 10px;
      font-size: 1em;
      background: #fafafa;
      transition: all 0.3s;
    }
    input:focus, textarea:focus {
      border-color: var(--kurayami-pink);
      outline: none;
      box-shadow: 0 0 0 3px rgba(236, 64, 122, 0.2);
    }
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    button {
      background: linear-gradient(to right, var(--kurayami-purple), var(--kurayami-pink));
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: bold;
      margin: 5px 5px 5px 0;
      box-shadow: var(--shadow);
      transition: all 0.3s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(106, 27, 154, 0.4);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .post {
      background: var(--kurayami-light);
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 10px;
      border-left: 4px solid var(--kurayami-pink);
      transition: transform 0.2s;
    }
    .post:hover {
      transform: translateX(3px);
    }
    .post h3 {
      margin: 0 0 8px;
      color: var(--kurayami-dark);
      font-family: 'Dancing Script', cursive;
      font-size: 1.2em;
    }
    .btn-group {
      display: flex;
      gap: 5px;
    }
    #kurayamiChat {
      position: fixed;
      bottom: 15px;
      right: 15px;
      background: white;
      padding: 10px 15px;
      border-radius: 20px;
      box-shadow: var(--shadow);
      font-size: 0.9em;
      color: var(--kurayami-purple);
      font-weight: bold;
      max-width: 80%;
      text-align: center;
      display: flex;
      align-items: center;
      gap: 5px;
      z-index: 100;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.03); }
    }
    #banNotice {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(74, 20, 140, 0.98);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      z-index: 9999;
      padding: 15px;
      display: none;
      backdrop-filter: blur(5px);
    }
    #banNotice.show {
      display: flex;
      animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    #countdown {
      font-size: 2em;
      margin: 15px 0;
      color: #ff5252;
      font-weight: bold;
    }
    #deviceId {
      font-size: 0.7em;
      color: #e0e0e0;
    }
    #reloadNotice {
      background: linear-gradient(to right, #ff5252, #f50057);
      color: white;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
      border-radius: 10px;
      font-size: 0.9em;
      box-shadow: var(--shadow);
      animation: warning 2s infinite;
    }
    @keyframes warning {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }
    .love-mode {
      border: 2px solid #ff4081 !important;
      box-shadow: 0 0 10px rgba(255,64,129,0.4) !important;
      animation: lovePulse 1.5s infinite;
    }
    @keyframes lovePulse {
      0% { box-shadow: 0 0 10px rgba(255,64,129,0.4); }
      50% { box-shadow: 0 0 15px rgba(255,64,129,0.6); }
      100% { box-shadow: 0 0 10px rgba(255,64,129,0.4); }
    }
    .kurayami-heart {
      color: #ff4081;
      font-size: 1.1em;
      animation: heartbeat 1.5s infinite;
    }
    @keyframes heartbeat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    .warning-banner {
      background: #fff3cd;
      color: #856404;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
      font-weight: bold;
      text-align: center;
      border: 1px solid #ffc107;
      font-size: 0.9em;
    }
    .permanent-ban {
      background: #f8d7da;
      color: #721c24;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
      font-weight: bold;
      text-align: center;
      border: 1px solid #dc3545;
      font-size: 0.9em;
    }
    .law-notice {
      background: #d1ecf1;
      color: #0c5460;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
      font-weight: bold;
      text-align: center;
      border: 1px solid #17a2b8;
      font-size: 0.9em;
    }
    .fb-link {
      color: #1877f2;
      text-decoration: underline;
      font-weight: bold;
      word-break: break-all;
    }
    @media (max-width: 600px) {
      header {
        font-size: 1.5em;
        padding: 12px;
      }
      main {
        padding: 10px;
      }
      h2 {
        font-size: 1.3em;
      }
      input, textarea {
        padding: 8px;
        font-size: 0.9em;
      }
      textarea {
        min-height: 100px;
      }
      button {
        padding: 8px 12px;
        font-size: 0.85em;
      }
      .post {
        padding: 10px;
      }
      .post h3 {
        font-size: 1.1em;
      }
      #kurayamiChat {
        padding: 8px 12px;
        font-size: 0.85em;
        max-width: 70%;
      }
      #banNotice {
        font-size: 1.2em;
        padding: 10px;
      }
      #countdown {
        font-size: 1.8em;
      }
      #deviceId {
        font-size: 0.65em;
      }
      .warning-banner, .permanent-ban, .law-notice {
        font-size: 0.85em;
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <header>Kurayami – Viết Cảm Xúc</header>
  
  <div id="reloadNotice">Web Kurayami – Tôi không nằm ngoài pháp luật.</div>

  <main>
    <div id="status"></div>

    <h2>Viết Gì Đó, Kurayami Đang Nghe</h2>
    <input id="title" type="text" placeholder="Tiêu đề..." oninput="kurayamiSpeak()" />
    <textarea id="content" placeholder="Viết cảm xúc... Kurayami đang nghe" oninput="kurayamiSpeak()"></textarea>
    <div style="display:flex; gap:5px;">
      <button id="saveBtn" onclick="savePost()">Gửi</button>
      <button onclick="clearAll()">Xóa Hết</button>
    </div>

    <hr style="border: 1px dashed #e1bee7; margin: 20px 0;">

    <h2>Kho Cảm Xúc</h2>
    <div id="posts"></div>
  </main>

  <div id="kurayamiChat">
    <span class="kurayami-heart">♥</span>
    <span id="chatText">đang nghe...</span>
  </div>

  <div id="banNotice">
    <p style="font-size:2em; font-family:'Dancing Script',cursive; margin:0;">Kurayami Buồn</p>
    <p id="banReason" style="margin:15px 0; font-size:1em;"></p>
    <div id="countdown"></div>
    <p id="deviceId"></p>
    <p style="font-size:0.8em; margin-top:15px; line-height:1.5;">
      Cố ý hay cố tình, cấm 24h.<br>
      Không bypass, không fake VPN, không reload.<br>
      <span style="color:#ffeb3b;">Internet không ngoài pháp luật.</span>
    </p>
  </div>

  <script>
    const postsDiv = document.getElementById('posts');
    const banNotice = document.getElementById('banNotice');
    const banReasonEl = document.getElementById('banReason');
    const countdownEl = document.getElementById('countdown');
    const deviceIdEl = document.getElementById('deviceId');
    const saveBtn = document.getElementById('saveBtn');
    const statusDiv = document.getElementById('status');
    const kurayamiChat = document.getElementById('kurayamiChat');
    const chatText = document.getElementById('chatText');
    const titleInput = document.getElementById('title');
    const contentInput = document.getElementById('content');

    // LOẠI BỎ DẤU TIẾNG VIỆT
    function removeDiacritics(str) {
      return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/đ/g, 'd').replace(/Đ/g, 'D');
    }

    // TẠO DEVICE ID
    let deviceId = localStorage.getItem('kurayami_device_id');
    if (!deviceId) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillText('Kurayami Law ID', 2, 2);
      const data = canvas.toDataURL();
      deviceId = btoa(data + navigator.userAgent + screen.width + screen.height + navigator.language + Date.now()).substring(0, 32);
      localStorage.setItem('kurayami_device_id', deviceId);
    }
    deviceIdEl.textContent = `Máy: ${deviceId}`;

    // TỪ KHÓA CẤM
    const bannedKeywords = {
      vnch: ['vnch', 'viet nam cong hoa', 'nguy quyen', 'nguy quan'],
      dcsvn: ['dcs vn', 'dang cong san viet nam', 'dang csvn'],
      ho: ['bac ho', 'ho chi minh', 'bac h'],
      giap: ['bac giap', 'vo nguyen giap'],
      liet_si: /liet\s*si|anh\s*hung.*(chui|xuc pham|do|ke)/i
    };

    const offensiveWords = {
      vnch: ['nguy', 'phan dong', 'ban nuoc', 'tay sai'],
      ho: ['ke', 'do', 'gia', 'doi', 'phan', 'toi do'],
      giap: ['phan', 'boi', 'toi do', 'ke']
    };

    // TỪ KHÓA TÌNH YÊU
    const loveKeywords = ['yeu', 'thuong', 'nho', 'dau', 'tan vo', 'chia tay', 'co don', 'tinh yeu', 'buon', 'khoc'];

    // LƯU CẤM
    const banKey = `kurayami_ban_${deviceId}`;
    let banData = JSON.parse(localStorage.getItem(banKey) || 'null');

    // KIỂM TRA CẤM
    function checkBan() {
      if (!banData) return;
      const now = Date.now();
      if (banData.permanent) {
        showPermanentBan();
      } else if (banData.until > now) {
        startCountdown(banData.until, banData.reason);
      } else {
        localStorage.removeItem(banKey);
        banData = null;
      }
    }

    function showPermanentBan() {
      banReasonEl.innerHTML = `
        <div class="permanent-ban">
          <p style="margin:0;">CẤM VĨNH VIỄN</p>
          <p>Xúc phạm nghiêm trọng.</p>
        </div>
        <div class="law-notice">
          Web Kurayami – Tôi không nằm ngoài pháp luật.<br>
          Không bypass, không fake VPN, không reload.
        </div>
        <p style="margin-top:10px; font-size:0.8em;">
          Muốn mở ban? Liên hệ Habato:<br>
          <a href="https://www.facebook.com/share/1LU63c2hE6/" target="_blank" class="fb-link">facebook.com/share/1LU63c2hE6/</a>
        </p>
      `;
      banNotice.classList.add('show');
      disableAllInputs();
    }

    function startCountdown(until, reason) {
      banReasonEl.innerHTML = `
        <div class="warning-banner">
          <p style="margin:0;">CẤM 24 GIỜ</p>
          <p>Cố ý hay cố tình, cấm 24h.</p>
          <p>Không bypass, không fake VPN, không reload.</p>
        </div>
      `;
      banNotice.classList.add('show');
      disableAllInputs();

      const interval = setInterval(() => {
        const remaining = Math.max(0, Math.floor((until - Date.now()) / 1000));
        if (remaining === 0) {
          clearInterval(interval);
          banNotice.classList.remove('show');
          localStorage.removeItem(banKey);
          banData = null;
          location.reload();
          return;
        }
        const h = String(Math.floor(remaining / 3600)).padStart(2, '0');
        const m = String(Math.floor((remaining % 3600) / 60)).padStart(2, '0');
        const s = String(remaining % 60).padStart(2, '0');
        countdownEl.textContent = `${h}:${m}:${s}`;
      }, 1000);
    }

    function disableAllInputs() {
      saveBtn.disabled = true;
      document.querySelectorAll('button, input, textarea').forEach(el => el.disabled = true);
    }

    // PHÂN TÍCH NỘI DUNG
    function analyzePost(title, content) {
      const originalText = `${title} ${content}`.toLowerCase();
      const cleanText = removeDiacritics(originalText);

      let isVNCHMention = false;
      let isOffensive = false;
      const errors = [];

      for (const kw of bannedKeywords.vnch) {
        if (cleanText.includes(kw)) {
          isVNCHMention = true;
          for (const bad of offensiveWords.vnch) {
            if (cleanText.includes(bad)) {
              isOffensive = true;
              errors.push(`Xúc phạm VNCH với từ: "${bad}"`);
            }
          }
        }
      }

      if (bannedKeywords.dcsvn.some(kw => cleanText.includes(kw))) {
        isOffensive = true;
        errors.push('Xúc phạm Đảng Cộng sản Việt Nam');
      }
      if (bannedKeywords.ho.some(kw => cleanText.includes(kw))) {
        for (const bad of offensiveWords.ho) {
          if (cleanText.includes(bad)) {
            isOffensive = true;
            errors.push(`Xúc phạm Bác Hồ với từ: "${bad}"`);
          }
        }
      }
      if (bannedKeywords.giap.some(kw => cleanText.includes(kw))) {
        for (const bad of offensiveWords.giap) {
          if (cleanText.includes(bad)) {
            isOffensive = true;
            errors.push(`Xúc phạm Đại tướng Võ Nguyên Giáp với từ: "${bad}"`);
          }
        }
      }
      if (bannedKeywords.liet_si.test(cleanText)) {
        isOffensive = true;
        errors.push('Xúc phạm các anh hùng liệt sĩ');
      }

      return { isVNCHMention, isOffensive, errors };
    }

    // KURAYAMI NÓI
    const kurayamiMessages = {
      default: ['đang nghe...', 'ở đây nè', 'kể đi nào', 'cảm xúc bạn quý giá'],
      love: ['tình yêu khó quá ha', 'ôm cái nè', 'đừng buồn, có Kurayami đây', 'sẽ vui cùng bạn'],
      vnch: ['Nhắc VNCH → cấm 24h nha', 'Kurayami phải tuân thủ luật', 'Không bypass được đâu']
    };

    function kurayamiSpeak() {
      const title = titleInput.value.toLowerCase();
      const content = contentInput.value.toLowerCase();
      const cleanText = removeDiacritics(`${title} ${content}`);

      if (loveKeywords.some(kw => cleanText.includes(kw))) {
        const msg = kurayamiMessages.love[Math.floor(Math.random() * kurayamiMessages.love.length)];
        chatText.innerHTML = `${msg} <span class="kurayami-heart">♥</span>`;
        titleInput.classList.add('love-mode');
        contentInput.classList.add('love-mode');
        setTimeout(() => {
          titleInput.classList.remove('love-mode');
          contentInput.classList.remove('love-mode');
        }, 2000);
        return;
      }

      if (bannedKeywords.vnch.some(kw => cleanText.includes(kw))) {
        chatText.textContent = kurayamiMessages.vnch[Math.floor(Math.random() * kurayamiMessages.vnch.length)];
        return;
      }

      chatText.textContent = kurayamiMessages.default[Math.floor(Math.random() * kurayamiMessages.default.length)];
    }

    // LƯU BÀI
    function savePost() {
      const title = titleInput.value.trim();
      const content = contentInput.value.trim();
      if (!title || !content) {
        chatText.textContent = "cần tiêu đề và nội dung";
        return;
      }

      const analysis = analyzePost(title, content);

      if (analysis.isOffensive) {
        const reason = `Xúc phạm: ${analysis.errors.join('; ')}`;
        localStorage.setItem(banKey, JSON.stringify({ permanent: true, reason }));
        showPermanentBan();
        return;
      }

      if (analysis.isVNCHMention) {
        const reason = 'Nhắc VNCH dù cố ý hay cố tình';
        const until = Date.now() + 24 * 60 * 60 * 1000;
        localStorage.setItem(banKey, JSON.stringify({ until, reason, permanent: false }));
        startCountdown(until, reason);
        statusDiv.innerHTML = '<div class="warning-banner">Nhắc VNCH → Cấm 24h.</div>';
        return;
      }

      const post = { id: Date.now(), title, content };
      const posts = JSON.parse(localStorage.getItem('kurayami_posts') || '[]');
      posts.push(post);
      localStorage.setItem('kurayami_posts', JSON.stringify(posts));
      titleInput.value = '';
      contentInput.value = '';
      loadPosts();
      chatText.innerHTML = `đã lưu! <span class="kurayami-heart">♥</span>`;
    }

    // HIỂN THỊ BÀI
    function loadPosts() {
      postsDiv.innerHTML = '';
      const posts = JSON.parse(localStorage.getItem('kurayami_posts') || '[]');
      posts.reverse().forEach(post => {
        const div = document.createElement('div');
        div.className = 'post';
        div.innerHTML = `
          <h3>${post.title}</h3>
          <div class="btn-group">
            <button onclick="viewPost(${post.id})">Xem</button>
            <button onclick="deletePost(${post.id})">Xóa</button>
          </div>
        `;
        postsDiv.appendChild(div);
      });
    }

    function viewPost(id) {
      const posts = JSON.parse(localStorage.getItem('kurayami_posts') || '[]');
      const post = posts.find(p => p.id === id);
      if (post) alert(`Ký ức:\n\n${post.title}\n\n${post.content}`);
    }

    function deletePost(id) {
      if (confirm('Xóa ký ức này?')) {
        let posts = JSON.parse(localStorage.getItem('kurayami_posts') || '[]');
        posts = posts.filter(p => p.id !== id);
        localStorage.setItem('kurayami_posts', JSON.stringify(posts));
        loadPosts();
      }
    }

    function clearAll() {
      if (confirm('Xóa hết ký ức?')) {
        localStorage.removeItem('kurayami_posts');
        loadPosts();
      }
    }

    // KHỞI ĐỘNG
    checkBan();
    loadPosts();
    kurayamiSpeak();

    titleInput.addEventListener('input', kurayamiSpeak);
    contentInput.addEventListener('input', kurayamiSpeak);

    window.addEventListener('load', () => {
      document.getElementById('reloadNotice').style.display = 'block';
    });
  </script>
</body>
</html>
