<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Viết Văn & Viết Sử - Kurayami</title>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --kurayami-purple: #6a1b9a;
      --kurayami-pink: #ec407a;
      --kurayami-light: #f3e5f5;
      --kurayami-dark: #4a148c;
      --shadow: 0 4px 15px rgba(106, 27, 154, 0.2);
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #ede7f6 0%, #f3e5f5 100%);
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background: linear-gradient(to right, var(--kurayami-purple), var(--kurayami-pink));
      color: white;
      padding: 20px;
      text-align: center;
      font-family: 'Dancing Script', cursive;
      font-size: 2.2em;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    header::after {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="%23ffffff20" d="M0,50 Q25,30 50,50 T100,50 Q75,70 50,50 T0,50"/></svg>');
      background-size: 60px;
      animation: float 6s infinite ease-in-out;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    main {
      max-width: 850px;
      margin: 30px auto;
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: var(--shadow);
      position: relative;
    }
    h2 {
      color: var(--kurayami-purple);
      font-family: 'Dancing Script', cursive;
      font-size: 1.8em;
      margin-bottom: 15px;
      text-align: center;
    }
    input, textarea {
      width: 100%;
      padding: 14px;
      margin: 12px 0;
      border: 2px solid #e1bee7;
      border-radius: 12px;
      font-size: 1.1em;
      transition: all 0.3s;
      background: #fafafa;
    }
    input:focus, textarea:focus {
      border-color: var(--kurayami-pink);
      outline: none;
      box-shadow: 0 0 0 3px rgba(236, 64, 122, 0.2);
    }
    button {
      background: linear-gradient(to right, var(--kurayami-purple), var(--kurayami-pink));
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      margin: 8px 5px 8px 0;
      font-size: 1em;
      font-weight: bold;
      transition: all 0.3s;
      box-shadow: 0 3px 8px rgba(106, 27, 154, 0.3);
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(106, 27, 154, 0.4);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .post {
      background: var(--kurayami-light);
      padding: 18px;
      border-radius: 16px;
      margin-bottom: 15px;
      border-left: 5px solid var(--kurayami-pink);
      transition: transform 0.2s;
    }
    .post:hover {
      transform: translateX(5px);
    }
    .post h3 {
      margin: 0 0 10px;
      color: var(--kurayami-dark);
      font-family: 'Dancing Script', cursive;
      font-size: 1.4em;
    }
    .btn-group {
      margin-top: 12px;
    }
    #kurayamiChat {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 15px 20px;
      border-radius: 50px;
      box-shadow: var(--shadow);
      font-size: 1.1em;
      color: var(--kurayami-purple);
      font-weight: bold;
      animation: pulse 2s infinite;
      z-index: 100;
      max-width: 300px;
      text-align: center;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    #banNotice {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(74, 20, 140, 0.98);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 1.6em;
      text-align: center;
      z-index: 9999;
      padding: 30px;
      display: none;
      backdrop-filter: blur(8px);
    }
    #banNotice.show {
      display: flex;
      animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    #countdown {
      font-size: 3em;
      margin: 20px 0;
      color: #ff5252;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(255,82,82,0.5);
    }
    #deviceId {
      font-size: 0.8em;
      margin-top: 15px;
      color: #e0e0e0;
    }
    #reloadNotice {
      background: linear-gradient(to right, #ff5252, #f50057);
      color: white;
      padding: 14px;
      text-align: center;
      font-weight: bold;
      margin-bottom: 20px;
      border-radius: 12px;
      font-size: 1.1em;
      box-shadow: 0 4px 10px rgba(245,0,87,0.3);
      animation: warning 2s infinite;
    }
    @keyframes warning {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }
    .love-mode {
      border: 3px solid #ff4081 !important;
      box-shadow: 0 0 15px rgba(255,64,129,0.4) !important;
      animation: lovePulse 1.5s infinite;
    }
    @keyframes lovePulse {
      0% { box-shadow: 0 0 15px rgba(255,64,129,0.4); }
      50% { box-shadow: 0 0 25px rgba(255,64,129,0.7); }
      100% { box-shadow: 0 0 15px rgba(255,64,129,0.4); }
    }
    .kurayami-heart {
      color: #ff4081;
      font-size: 1.3em;
      animation: heartbeat 1.5s infinite;
    }
    @keyframes heartbeat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    .warning-banner {
      background: #fff3cd;
      color: #856404;
      padding: 12px;
      border-radius: 12px;
      margin: 15px 0;
      font-weight: bold;
      text-align: center;
      border: 2px solid #ffc107;
      animation: shake 0.5s;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    .permanent-ban {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 12px;
      margin: 15px 0;
      font-weight: bold;
      text-align: center;
      border: 2px solid #dc3545;
      font-size: 1.1em;
    }
    .law-notice {
      background: #d1ecf1;
      color: #0c5460;
      padding: 12px;
      border-radius: 12px;
      margin: 15px 0;
      font-weight: bold;
      text-align: center;
      border: 2px solid #17a2b8;
    }
    .fb-link {
      color: #1877f2;
      text-decoration: underline;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>Kurayami – Nơi Tình Yêu & Văn Chương Gặp Nhau</header>
  
  <div id="reloadNotice">Web Kurayami – Tôi không nằm ngoài pháp luật. Internet không nằm ngoài pháp luật.</div>

  <main>
    <div id="status"></div>

    <h2>Viết Gì Cũng Được, Kurayami Luôn Ở Đây</h2>
    <input id="title" type="text" placeholder="Tiêu đề cảm xúc của bạn..." oninput="kurayamiSpeak()" />
    <textarea id="content" rows="8" placeholder="Hãy viết ra cảm xúc... Kurayami đang lắng nghe" oninput="kurayamiSpeak()"></textarea>
    <button id="saveBtn" onclick="savePost()">Gửi Cho Kurayami</button>
    <button onclick="clearAll()">Xóa Hết Ký Ức</button>

    <hr style="border: 1px dashed #e1bee7; margin: 30px 0;">

    <h2>Kho Báu Của Bạn</h2>
    <div id="posts"></div>
  </main>

  <!-- Kurayami Chat Bubble -->
  <div id="kurayamiChat">
    <span class="kurayami-heart">Kurayami</span>
    <span id="chatText">đang lắng nghe bạn...</span>
  </div>

  <!-- Ban Notice -->
  <div id="banNotice">
    <p style="font-size:2.5em; font-family:'Dancing Script',cursive; margin:0;">Kurayami Buồn</p>
    <p id="banReason" style="margin:20px 0; font-size:1.2em;"></p>
    <div id="countdown"></div>
    <p id="deviceId"></p>
    <p style="font-size:0.9em; margin-top:25px; line-height:1.6;">
      Cho dù bạn cố ý hay cố tình, chúng tôi đều sẽ ban 24h.<br>
      Không bypass, không fake VPN, không reload được.<br>
      <span style="color:#ffeb3b;">Internet không nằm ngoài pháp luật.</span>
    </p>
  </div>

  <script>
    const postsDiv = document.getElementById('posts');
    const banNotice = document.getElementById('banNotice');
    const banReasonEl = document.getElementById('banReason');
    const countdownEl = document.getElementById('countdown');
    const deviceIdEl = document.getElementById('deviceId');
    const saveBtn = document.getElementById('saveBtn');
    const statusDiv = document.getElementById('status');
    const kurayamiChat = document.getElementById('kurayamiChat');
    const chatText = document.getElementById('chatText');
    const titleInput = document.getElementById('title');
    const contentInput = document.getElementById('content');

    // === HÀM LOẠI BỎ DẤU TIẾNG VIỆT ===
    function removeDiacritics(str) {
      return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/đ/g, 'd').replace(/Đ/g, 'D');
    }

    // === TẠO DEVICE ID (Fingerprint) ===
    let deviceId = localStorage.getItem('kurayami_device_id');
    if (!deviceId) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillText('Kurayami Law ID', 2, 2);
      const data = canvas.toDataURL();
      deviceId = btoa(data + navigator.userAgent + screen.width + screen.height + navigator.language + Date.now()).substring(0, 32);
      localStorage.setItem('kurayami_device_id', deviceId);
    }
    deviceIdEl.textContent = `Máy: ${deviceId}`;

    // === DANH SÁCH TỪ KHÓA CẤM (CẢ CÓ DẤU & KHÔNG DẤU) ===
    const bannedKeywords = {
      vnch: ['vnch', 'viet nam cong hoa', 'nguy quyen', 'nguy quan'],
      dcsvn: ['dcs vn', 'dang cong san viet nam', 'dang csvn'],
      ho: ['bac ho', 'ho chi minh', 'bac h'],
      giap: ['bac giap', 'vo nguyen giap'],
      liet_si: /liet\s*si|anh\s*hung.*(chui|xuc pham|do|ke)/i
    };

    const offensiveWords = {
      vnch: ['nguy', 'phan dong', 'ban nuoc', 'tay sai'],
      ho: ['ke', 'do', 'gia', 'doi', 'phan', 'toi do'],
      giap: ['phan', 'boi', 'toi do', 'ke']
    };

    // === TỪ KHÓA TÌNH YÊU ===
    const loveKeywords = ['yeu', 'thuong', 'nho', 'dau', 'tan vo', 'chia tay', 'co don', 'tinh yeu', 'buon', 'khoc'];

    // === LƯU CẤM THEO MÁY ===
    const banKey = `kurayami_ban_${deviceId}`;
    let banData = JSON.parse(localStorage.getItem(banKey) || 'null');

    // === KIỂM TRA CẤM ===
    function checkBan() {
      if (!banData) return;
      const now = Date.now();
      if (banData.permanent) {
        showPermanentBan();
      } else if (banData.until > now) {
        startCountdown(banData.until, banData.reason);
      } else {
        localStorage.removeItem(banKey);
        banData = null;
      }
    }

    function showPermanentBan() {
      banReasonEl.innerHTML = `
        <div class="permanent-ban">
          <p style="margin:0; font-size:1.3em;">CẤM VĨNH VIỄN</p>
          <p>Bạn đã xúc phạm những điều thiêng liêng.</p>
          <p>ĐCS VN, Bác Hồ, Bác Giáp, anh hùng liệt sĩ...</p>
        </div>
        <div class="law-notice">
          Web Kurayami – Tôi không nằm ngoài pháp luật.<br>
          Internet không nằm ngoài pháp luật.<br>
          Không bypass, không fake VPN, không reload được.
        </div>
        <p style="margin-top:20px;">
          Muốn mở ban? Giải thích với Habato:<br>
          <a href="https://www.facebook.com/share/1LU63c2hE6/" target="_blank" class="fb-link">https://www.facebook.com/share/1LU63c2hE6/</a>
        </p>
      `;
      banNotice.classList.add('show');
      disableAllInputs();
    }

    function startCountdown(until, reason) {
      banReasonEl.innerHTML = `
        <div class="warning-banner">
          <p style="margin:0; font-size:1.2em;">CẤM 24 GIỜ</p>
          <p>Cho dù bạn cố ý hay cố tình, chúng tôi đều sẽ ban 24h.</p>
          <p>Không bypass, không fake VPN, không reload được.</p>
        </div>
        <p style="margin-top:15px; color:#ffeb3b;">
          Internet không nằm ngoài pháp luật.
        </p>
      `;
      banNotice.classList.add('show');
      disableAllInputs();

      const interval = setInterval(() => {
        const remaining = Math.max(0, Math.floor((until - Date.now()) / 1000));
        if (remaining === 0) {
          clearInterval(interval);
          banNotice.classList.remove('show');
          localStorage.removeItem(banKey);
          banData = null;
          location.reload();
          return;
        }
        const h = String(Math.floor(remaining / 3600)).padStart(2, '0');
        const m = String(Math.floor((remaining % 3600) / 60)).padStart(2, '0');
        const s = String(remaining % 60).padStart(2, '0');
        countdownEl.textContent = `${h}:${m}:${s}`;
      }, 1000);
    }

    function disableAllInputs() {
      saveBtn.disabled = true;
      document.querySelectorAll('button, input, textarea').forEach(el => el.disabled = true);
    }

    // === PHÂN TÍCH NỘI DUNG (CẢ CÓ DẤU & KHÔNG DẤU) ===
    function analyzePost(title, content) {
      const originalText = `${title} ${content}`.toLowerCase();
      const cleanText = removeDiacritics(originalText);

      let isVNCHMention = false;
      let isOffensive = false;
      const errors = [];

      // Kiểm tra VNCH (có dấu & không dấu)
      for (const kw of bannedKeywords.vnch) {
        if (cleanText.includes(kw)) {
          isVNCHMention = true;
          for (const bad of offensiveWords.vnch) {
            if (cleanText.includes(bad)) {
              isOffensive = true;
              errors.push(`Xúc phạm VNCH với từ: "${bad}"`);
            }
          }
        }
      }

      // Kiểm tra các đối tượng khác
      if (bannedKeywords.dcsvn.some(kw => cleanText.includes(kw))) {
        isOffensive = true;
        errors.push('Xúc phạm Đảng Cộng sản Việt Nam');
      }
      if (bannedKeywords.ho.some(kw => cleanText.includes(kw))) {
        for (const bad of offensiveWords.ho) {
          if (cleanText.includes(bad)) {
            isOffensive = true;
            errors.push(`Xúc phạm Bác Hồ với từ: "${bad}"`);
          }
        }
      }
      if (bannedKeywords.giap.some(kw => cleanText.includes(kw))) {
        for (const bad of offensiveWords.giap) {
          if (cleanText.includes(bad)) {
            isOffensive = true;
            errors.push(`Xúc phạm Đại tướng Võ Nguyên Giáp với từ: "${bad}"`);
          }
        }
      }
      if (bannedKeywords.liet_si.test(cleanText)) {
        isOffensive = true;
        errors.push('Xúc phạm các anh hùng liệt sĩ');
      }

      return { isVNCHMention, isOffensive, errors };
    }

    // === KURAYAMI NÓI CHUYỆN ===
    const kurayamiMessages = {
      default: [
        "đang lắng nghe bạn...",
        "ở đây mà",
        "thích nghe bạn kể lắm",
        "cảm xúc của bạn rất quý giá"
      ],
      love: [
        "hiểu mà... Tình yêu thật khó",
        "ôm bạn một cái nhé",
        "dù ai làm bạn đau, Kurayami vẫn ở đây",
        "sẽ vui cùng bạn khi bạn hạnh phúc"
      ],
      vnch: [
        "Cho dù bạn cố ý hay cố tình, nhắc VNCH → ban 24h",
        "Kurayami phải tuân thủ luật",
        "Không bypass, không fake VPN, không reload được"
      ]
    };

    function kurayamiSpeak() {
      const title = titleInput.value.toLowerCase();
      const content = contentInput.value.toLowerCase();
      const cleanText = removeDiacritics(`${title} ${content}`);

      if (loveKeywords.some(kw => cleanText.includes(kw))) {
        const msg = kurayamiMessages.love[Math.floor(Math.random() * kurayamiMessages.love.length)];
        chatText.innerHTML = `${msg} <span class="kurayami-heart">Kurayami</span>`;
        titleInput.classList.add('love-mode');
        contentInput.classList.add('love-mode');
        setTimeout(() => {
          titleInput.classList.remove('love-mode');
          contentInput.classList.remove('love-mode');
        }, 3000);
        return;
      }

      if (bannedKeywords.vnch.some(kw => cleanText.includes(kw))) {
        chatText.textContent = kurayamiMessages.vnch[Math.floor(Math.random() * kurayamiMessages.vnch.length)];
        return;
      }

      const msg = kurayamiMessages.default[Math.floor(Math.random() * kurayamiMessages.default.length)];
      chatText.textContent = msg;
    }

    // === LƯU BÀI ===
    function savePost() {
      const title = titleInput.value.trim();
      const content = contentInput.value.trim();
      if (!title || !content) {
        chatText.textContent = "cần cả tiêu đề và nội dung cơ";
        return;
      }

      const analysis = analyzePost(title, content);

      if (analysis.isOffensive) {
        const reason = `Xúc phạm nghiêm trọng: ${analysis.errors.join('; ')}`;
        localStorage.setItem(banKey, JSON.stringify({ permanent: true, reason }));
        showPermanentBan();
        return;
      }

      if (analysis.isVNCHMention) {
        const reason = 'Nhắc đến VNCH dù cố ý hay cố tình';
        const until = Date.now() + 24 * 60 * 60 * 1000;
        localStorage.setItem(banKey, JSON.stringify({ until, reason, permanent: false }));
        startCountdown(until, reason);
        statusDiv.innerHTML = '<div class="warning-banner">Đã nhắc VNCH → Cấm 24h. Không bypass được.</div>';
        return;
      }

      const post = { id: Date.now(), title, content };
      const posts = JSON.parse(localStorage.getItem('kurayami_posts') || '[]');
      posts.push(post);
      localStorage.setItem('kurayami_posts', JSON.stringify(posts));
      titleInput.value = '';
      contentInput.value = '';
      loadPosts();
      chatText.innerHTML = `đã lưu bài của bạn! <span class="kurayami-heart">Kurayami</span>`;
    }

    // === HIỂN THỊ DANH SÁCH ===
    function loadPosts() {
      postsDiv.innerHTML = '';
      const posts = JSON.parse(localStorage.getItem('kurayami_posts') || '[]');
      posts.reverse().forEach(post => {
        const div = document.createElement('div');
        div.className = 'post';
        div.innerHTML = `
          <h3>${post.title}</h3>
          <div class="btn-group">
            <button onclick="viewPost(${post.id})">Xem</button>
            <button onclick="deletePost(${post.id})">Xóa</button>
          </div>
        `;
        postsDiv.appendChild(div);
      });
    }

    function viewPost(id) {
      const posts = JSON.parse(localStorage.getItem('kurayami_posts') || '[]');
      const post = posts.find(p => p.id === id);
      if (post) alert(`Kurayami mở lại ký ức:\n\n${post.title}\n\n${post.content}`);
    }

    function deletePost(id) {
      if (confirm('Kurayami hỏi: Bạn chắc muốn xóa kỷ niệm này?')) {
        let posts = JSON.parse(localStorage.getItem('kurayami_posts') || '[]');
        posts = posts.filter(p => p.id !== id);
        localStorage.setItem('kurayami_posts', JSON.stringify(posts));
        loadPosts();
      }
    }

    function clearAll() {
      if (confirm('Kurayami buồn lắm... Xóa hết ký ức sao?')) {
        localStorage.removeItem('kurayami_posts');
        loadPosts();
      }
    }

    // === KHỞI ĐỘNG ===
    checkBan();
    loadPosts();
    kurayamiSpeak();

    titleInput.addEventListener('input', kurayamiSpeak);
    contentInput.addEventListener('input', kurayamiSpeak);

    window.addEventListener('load', () => {
      document.getElementById('reloadNotice').style.display = 'block';
    });
  </script>
</body>
</html>
